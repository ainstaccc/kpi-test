ç¾åœ¨é–‹å§‹å»ºç«‹ã€Œç±³æ–¯ç‰¹ é–€å¸‚æœˆè€ƒæ ¸æŸ¥è©¢å¹³å°ï¼ˆPython Streamlit ç‰ˆï¼‰ã€

ä¾ä»¥ä¸‹æä¾›çš„è³‡è¨Šé€²è¡Œé–‹ç™¼ï¼š

1. è³‡æ–™ä¾†æº
â¬†ï¸ ä¸Šå‚³å«è€ƒæ ¸è³‡æ–™çš„ Excel æª”æ¡ˆ(å¦‚é™„ä»¶:2025.06_MST-PA.xlsx)>æª”æ¡ˆå·²å­˜åœ¨GitHub
https://github.com/ainstaccc/kpi-checker/tree/main
æŸ¥è©¢çµæœ-æ¨™é¡Œåˆ—é¡è‰²éœ€èˆ‡EXCELè¡¨æª”æ¡ˆä¸€è‡´

2. æŸ¥è©¢æ–¹å¼
è«‹å‹¾é¸é è¨ˆæŸ¥è©¢æ¬„ä½èˆ‡æ–¹å¼ï¼š
#å€åŸŸï¼ˆä¸‹æ‹‰é¸å–®ï¼‰æ¯”å°æª”æ¡ˆä¾†æº:[åˆ†é ]é–€åº— è€ƒæ ¸ç¸½è¡¨  Bæ¬„(å€ä¸»ç®¡)>è¼¸å‡ºå€ä¸»ç®¡ç›¸ç¬¦çš„å®Œæ•´è³‡æ–™åˆ—
é¸é …:
ææ”¿å‹³
é„§æ€æ€
æ—å®¥å„’
ç¾…å©‰å¿ƒ
ç‹å»ºæ¨¹
æ¥ŠèŒœè¿
é™³å®¥è“‰
å³å²±ä¾‘
ç¿è–é–”
é»ƒå•Ÿå‘¨
æ —æ™‰å±
ç‹ç‘è¾°

#éƒ¨é–€ç·¨è™Ÿï¼ˆé¸å¡«ï¼‰æ¯”å°æª”æ¡ˆä¾†æº:[åˆ†é ]é–€åº— è€ƒæ ¸ç¸½è¡¨ Cæ¬„(éƒ¨é–€ç·¨è™Ÿ)>è¼¸å‡ºéƒ¨é–€ç·¨è™Ÿç›¸ç¬¦çš„å®Œæ•´è³‡æ–™åˆ—
#å“¡å·¥ç·¨è™Ÿï¼ˆé¸å¡«ï¼‰æ¯”å°æª”æ¡ˆä¾†æº:[åˆ†é ]é–€åº— è€ƒæ ¸ç¸½è¡¨ Eæ¬„(å“¡ç·¨)>è¼¸å‡ºå“¡å·¥ç·¨è™Ÿç›¸ç¬¦çš„å®Œæ•´è³‡æ–™åˆ—
#äººå“¡å§“åï¼ˆé¸å¡«ï¼‰æ¯”å°æª”æ¡ˆä¾†æº:[åˆ†é ]é–€åº— è€ƒæ ¸ç¸½è¡¨ Fæ¬„(äººå“¡å§“å)>è¼¸å‡ºäººå“¡å§“åç›¸ç¬¦çš„å®Œæ•´è³‡æ–™åˆ—
#æŸ¥è©¢æœˆä»½ï¼ˆä¸‹æ‹‰é¸å–®ï¼‰æ¯”å°æª”æ¡ˆä¾†æº:[åˆ†é ]é–€åº— è€ƒæ ¸ç¸½è¡¨ A1(2025/06)>é è¨­2025/06ï¼Œç›®å‰åªæœ‰ä¸€å€‹é¸é …
(æŸ¥è©¢æŒ‰éˆ•)

æŸ¥è©¢æŒ‰éˆ•ä¸‹æ–¹é¡¯ç¤ºï¼šæœ¬æ¬¡è€ƒæ ¸ç­‰ç´šåˆ†å¸ƒ
ä¾†æº:[åˆ†é ]ç­‰ç´šåˆ†å¸ƒ A1:N15

----------
3. æŸ¥è©¢çµæœï¼šåˆ†ä¸Šä¸­ä¸‹ä¸‰éƒ¨ä»½ 
ä¾æŸ¥è©¢æ¢ä»¶æ¯”å°å„åˆ†é ä¸­å°æ‡‰æ¬„ä½ï¼ŒæŠ“å–ç¬¦åˆé …ç›®çš„æ‰€æœ‰ç­†æ•¸ï¼Œå¯«å…¥æŒ‡å®šçš„æ¬„ä½è³‡è¨Šï¼Œ
æŸ¥è©¢çµæœ äººæ•ˆåˆ†æï¼š(å¦‚åœ–)å¦‚ç‚ºå“¡ç·¨å‰‡è¦–ç‚ºæ–‡å­—(ä¸é ˆåƒåˆ†ä½æ¨£å¼)ã€å¦‚ç‚ºæ•¸å­—æ ¼å¼å‰‡å¯«å…¥è‡³å°æ•¸é»å¾Œä¸€ä½ã€å¦‚ç‚ºç›¸å°ç¸¾æ•ˆæˆ–æœƒå“¡ç‡è³‡è¨Šå‰‡é¡¯ç¤ºç‚º%ç™¾åˆ†æ¯”æ ¼å¼ 

<ä¸Š>é–€åº— è€ƒæ ¸ç¸½è¡¨
[ä¾†æºåˆ†é ]é–€åº— è€ƒæ ¸ç¸½è¡¨(å›ºå®šæ¨™é¡Œåˆ—A2:K2)
è€ƒæ ¸åˆ†é¡	
å€ä¸»ç®¡	
éƒ¨é–€ç·¨è™Ÿ	
éƒ¨é–€åç¨±	
å“¡ç·¨	
äººå“¡å§“å	
è€ƒæ ¸é …ç›®åˆ†æ•¸	
ç®¡ç†é …ç›®åˆ†æ•¸	
ç­‰ç´š	
éœ€è¨ªè«‡	
é‡é»é—œæ³¨
*å°æ‡‰æŸ¥è©¢æ¢ä»¶B:Fæ¬„=å€ä¸»ç®¡	éƒ¨é–€ç·¨è™Ÿ	éƒ¨é–€åç¨±	å“¡ç·¨	äººå“¡å§“å 
è¼¸å‡ºå°æ‡‰è³‡æ–™çš„A:Kæ¬„å®Œæ•´è³‡æ–™(å›ºå®šæ¨™é¡Œåˆ—A2:K2ï¼Œå…±11æ¬„) 
----------
<ä¸­>äººæ•ˆåˆ†æ
[ä¾†æºåˆ†é ]äººæ•ˆåˆ†æ(å›ºå®šæ¨™é¡Œåˆ—A2:O2)
å€ä¸»ç®¡	
éƒ¨é–€ç·¨è™Ÿ	
éƒ¨é–€åç¨±	
å“¡ç·¨	
äººå“¡å§“å	
è·å‹™åç¨±	
å€‹ç¸¾ç›®æ¨™	
å€‹ç¸¾è²¢ç»	
å€‹ç¸¾é”æˆ%	
å“ç‰Œå®¢å–®åƒ¹	
å€‹äººå®¢å–®åƒ¹	
å®¢å–®ç›¸å°ç¸¾æ•ˆ	
å“ç‰Œçµå¸³æœƒå“¡ç‡	
å€‹äººçµå¸³æœƒå“¡ç‡	
æœƒå“¡ç›¸å°ç¸¾æ•ˆ
 *å°æ‡‰æŸ¥è©¢æ¢ä»¶A:Eæ¬„=å€ä¸»ç®¡	éƒ¨é–€ç·¨è™Ÿ	éƒ¨é–€åç¨±	å“¡ç·¨	äººå“¡å§“å 
å¯«å…¥å°æ‡‰è³‡æ–™çš„A:Oæ¬„å®Œæ•´è³‡æ–™(å›ºå®šæ¨™é¡Œåˆ—A2:O2ï¼Œå…±15æ¬„) 
*äººæ•ˆåˆ†ææ¬„æ ¼å¼ï¼šIã€Lã€Mã€Nã€Oäº”æ¬„çš†å¯«å…¥ç‚ºç™¾åˆ†æ¯”æ ¼å¼
----------
<ä¸‹>è€ƒæ ¸æ˜ç´°(å…ˆå¯«åº—ä¸»ç®¡å€å¡Šã€å†å¯«åº—å“¡å€å¡Šï¼Œå›ºå®šæ¨™é¡Œåˆ—)
[ä¾†æºåˆ†é ]åº—é•·å‰¯åº— è€ƒæ ¸æ˜ç´°(å›ºå®šæ¨™é¡Œåˆ—B2:AB2)
ç¸½åˆ†	
ç´šåˆ¥	
éƒ¨é–€ç·¨è™Ÿ	
éƒ¨é–€åç¨±	
å“¡ç·¨	
äººå“¡å§“å	
è€ƒæ ¸åˆ†é¡	
å€ä¸»ç®¡	
è€ƒæ ¸ç•¶æœˆç‡Ÿæ”¶	
è€ƒæ ¸ç•¶æœˆç›®æ¨™	
(1)ç‡Ÿæ”¶é”æˆ	
(2)YOYåŠ åˆ†é …	
æ¥­ç¸¾é …ç›®åˆ†æ•¸	
ç­è¡¨ç•°å¸¸	
å‡ºå‹¤ç•°å¸¸	
ç®¡ç†åˆ†æ•¸_äººè³‡	
ç½°æ¬¾	
å¸³å·®	
ç£å°è¡¨	
ç®¡ç†åˆ†æ•¸_è²¡å‹™	
é©—æ”¶	
é©—é€€	
ç®¡ç†åˆ†æ•¸_å•†æ§	
æœå‹™å®¢è¨´	
ç®¡ç†åˆ†æ•¸_æœå‹™	
B+Cç¸½è¨ˆ30	
æ•™è‚²è¨“ç·´åŠ åˆ†é … 
*å°æ‡‰æŸ¥è©¢æ¢ä»¶D:Iæ¬„=éƒ¨é–€ç·¨è™Ÿ	éƒ¨é–€åç¨±	å“¡ç·¨	äººå“¡å§“å	è€ƒæ ¸åˆ†é¡	å€ä¸»ç®¡  
å¯«å…¥å°æ‡‰è³‡æ–™çš„B:ABæ¬„å®Œæ•´è³‡æ–™(å›ºå®šæ¨™é¡Œåˆ—B2:AB2ï¼Œå…±27æ¬„) 
**è‹¥ç„¡å°æ‡‰è³‡æ–™ï¼Œå‰‡é¡¯ç¤ºæ¨™é¡Œåˆ—å³å¯
----------
[ä¾†æºåˆ†é ]åº—å“¡å„²å‚™ è€ƒæ ¸æ˜ç´°(å›ºå®šæ¨™é¡Œåˆ—B2:AB2)
ç¸½åˆ†	
ç´šåˆ¥	
éƒ¨é–€ç·¨è™Ÿ	
åº—æ«ƒåç¨±	
å“¡ç·¨	
äººå“¡å§“å	
è€ƒæ ¸åˆ†é¡	
å€ä¸»ç®¡	
è€ƒæ ¸ç•¶æœˆç‡Ÿæ”¶	
è€ƒæ ¸ç•¶æœˆç›®æ¨™	
(1)ç‡Ÿæ”¶é”æˆ	
(2)YOYåŠ åˆ†é …	
åº—é‹ªæ¥­ç¸¾åˆ†æ•¸	
(3)å€‹ç¸¾é”æˆ	
å€‹ç¸¾åˆ†æ•¸	
(4)å€‹äººå®¢å–®	
æ¥­ç¸¾é …ç›®ç¸½åˆ†	
å€‹äººå‡ºå‹¤	
è«‹å‡æ› è·	
ç®¡ç†åˆ†æ•¸B1	
æ•™è‚²è¨“ç·´	
æœƒå“¡çµå¸³	
ç®¡ç†åˆ†æ•¸B2	
å€‹äººç½°å–®	
åº—é‹ªæœå‹™	
ç®¡ç†åˆ†æ•¸C	
B+Cç¸½è¨ˆ30
*å°æ‡‰æŸ¥è©¢æ¢ä»¶D:Iæ¬„=éƒ¨é–€ç·¨è™Ÿ	éƒ¨é–€åç¨±	å“¡ç·¨	äººå“¡å§“å	è€ƒæ ¸åˆ†é¡	å€ä¸»ç®¡  
å¯«å…¥å°æ‡‰è³‡æ–™çš„B:ABæ¬„å®Œæ•´è³‡æ–™(å›ºå®šæ¨™é¡Œåˆ—B2:AB2ï¼Œå…±27æ¬„) 
**è‹¥ç„¡å°æ‡‰è³‡æ–™ï¼Œå‰‡é¡¯ç¤ºæ¨™é¡Œåˆ—å³å¯
----------
æœ€ä¸‹æ–¹ä»¥ç´…å­—é†’ç›®æç¤ºï¼š 
â€»å¦‚å°åˆ†æ•¸æœ‰ç–‘å•ï¼Œè«‹æ´½å€ä¸»ç®¡/å“ç‰Œç¶“ç†èªªæ˜ã€‚ 



4. æ¬Šé™éœ€æ±‚ï¼š
é™å®šå¸³è™Ÿæ¸…å–®ï¼ˆè«‹æä¾› Gmail æ¸…å–®ï¼‰
å€åŸŸ(å°æ‡‰å€ä¸»ç®¡æ¬„)	gmailå¸³è™Ÿ
ææ”¿å‹³	fabio89608@gmail.com
é„§æ€æ€	124453221s@gmail.com
æ—å®¥å„’	yolu902@gmail.com
ç¾…å©‰å¿ƒ	a6108568@gmail.com
ç‹å»ºæ¨¹	Wmksue12976@gmail.com
æ¥ŠèŒœè¿	aqianyu8@gmail.com
é™³å®¥è“‰	happy0623091@gmail.com
å³å²±ä¾‘	cvcv0897@gmail.com
ç¿è–é–”	minkatieweng@gmail.com
é»ƒå•Ÿå‘¨	a0956505289@gmail.com
æ —æ™‰å±	Noncks@gmail.com
ç‹ç‘è¾°	vicecolife0969@gmail.com

éƒ¨é–€ç·¨è™Ÿ	éƒ¨é–€åç¨±	gmailå¸³è™Ÿ
LM018	Life8å°åŒ—è¥¿é–€èª å“åº—(LAKW)	life8x34@gmail.com
LM028	Life8æ–°åŒ—å®åŒ¯å»£å ´åº—(LAK)	life8x45@gmail.com
LM040	Life8å°åŒ—æ­¦æ˜Œèª å“åº—(LAKWE)	lm040@life8.com.tw
LM007	Life8å°åŒ—ä¿¡ç¾©A11åº—(L)	life8x25@gmail.com
LM019	Life8å®œè˜­æ–°æœˆåº—(LW)	life8x36@gmail.com
LM021	Life8åŸºéš†æ‘©äºæ™‚å°šåº—(LAKW)	life8x40@gmail.com
LM030	Life8æ–°åŒ—æ–°åº—è£•éš†åŸ(LW)	life8x48@gmail.com
LM038	Life8æ–°åŒ—æ¿æ©‹èª å“(LW)	lm038@life8.com.tw
LM036	Life8æ–°åŒ—æ°¸å’Œæ¯”æ¼¾(LW)	life8x60@gmail.com
LM046	Life8å°åŒ—ä¿¡ç¾©ATT	life8x64@gmail.com
LM033	Life8å—æ¸¯LaLaPort	life8x65@gmail.com
LS002	Life8æ¡ƒåœ’è¯æ³°åº—(LE)	life8x13@gmail.com
LM016	Life8æ¡ƒåœ’çµ±é ˜åº—	life8x31@gmail.com
LM004	Life8æ–°åŒ—ä¸­å’Œç’°çƒåº—(LW)	life8x19@gmail.com
LM023	Life8å°åŒ—å—æ¸¯CITYLI(LW)	life8x39@gmail.com
LM026	Life8æ–°åŒ—æ¿æ©‹ç’°çƒåº—(LAKW)	life8x43@gmail.com
LM024	Life8æ–°åŒ—æ¨¹æ—ç§€æ³°åº—	life8x41@gmail.com
LM031	Life8å°åŒ—ç¾éº—è¯åº—(LAKWE)	life8x57@gmail.com
LM035	Life8æ–°åŒ—æ±æ­¢iFGé é›„å»£å ´(LW)	life8x58@gmail.com
LM039	Life8æ–°åº—å°ç¢§æ½­ç«™åº—(LAKWE)	lm039@life8.com.tw
LM042	Life8æ¡ƒåœ’å°èŒ‚(LW)	life8x61@gmail.com
LM047	Life8å°åŒ—é ä¼	life8x66@gmail.com
LM022	Life8å°ä¸­LLPåº—(LAKWE)	life8x46@gmail.com
LS005	Life8å°ä¸­éº—å¯¶åº—(LAKWE)	life8x17@gmail.com
LM011	Life8å°ä¸­æ–‡å¿ƒç§€æ³°åº—	life8x23@gmail.com
LM014	Life8å°ä¸­è€è™åŸåº—(LAK)	life8x29@gmail.com
LM015	Life8å°ä¸­SOGOåº—(LAKWE)	life8x30@gmail.com
LM032	Life8å°ä¸­èª å“480åº—(LAK)	life8x56@gmail.com
LS004	Life8å°ä¸­ä¸‰äº•åº—(LE)	life8x38@gmail.com
LM002	Life8è‹—æ —å°šé †åº—(LAKE)	life8x16@gmail.com
LM003	Life8å°ä¸­æ–°æ™‚ä»£åº—(LW)	life8x18@gmail.com
LC001	Life8å°ä¸­å‹¤ç¾æ——è‰¦åº—	lc001@life8.com.tw
LC002	Life8å°ä¸­æ¾ç«¹æ——è‰¦åº—	life8x63@gmail.com
LK013	Life8æ–°ç«¹å·¨åŸ	
LM013	Life8å˜‰ç¾©ç§€æ³°åº—(LAKEM)	life8x28@gmail.com
LM006	Life8é«˜é›„å¤¢æ™‚ä»£åº—(LKWEM)	life8x20@gmail.com
LM001	Life8é«˜é›„SKMåº—(LAKE)	life8x14@gmail.com
LM009	Life8å±æ±ç’°çƒåº—(LAK)	life8x21@gmail.com
LM020	Life8é«˜é›„å²¡å±±æ¨‚è³¼åº—	life8x42@gmail.com
LM034	Life8é«˜é›„å·¦ç‡Ÿæ–°å…‰(LW)	life8x47@gmail.com
LM037	Life8é«˜é›„ç¾©äº«å¤©åœ°(LAKW)	lm037@life8.com.tw
LM041	Life8å°å—å—ç´¡åº—(LW)	
LM048	Life8é«˜é›„å¤§é ç™¾	life8x69@gmail.com
LS001	Life8é«˜é›„ç¾©å¤§Aå€åº—(LAKW)	life8x12@gmail.com
LS003	Life8é«˜é›„ç¾©å¤§Cå€åº—(LW)	life8x24@gmail.com
LM005	Life8å°å—å°è¥¿é–€åº—(LAKW)	life8x03@gmail.com
LM017	Life8å°å—Focusåº—(LW)	life8x32@gmail.com
LM045	Life8å˜‰ç¾©è€æ–¯	life8x62@gmail.com
LM044	Life8å°å—ç¢³ä½åº—(LAKW)	life8x67@gmail.com
AM005	ALL WEARSæ–°åŒ—ä¸­å’Œç’°çƒåº—(AKW	allwears08@gmail.com
AM007	ALL WEARSæ¡ƒåœ’å°èŒ‚åº—(AK)	allwears10@gmail.com
AM010	ALL WEARSå°åŒ—äº¬ç«™(AKW)	allwears16@gmail.com
AM015	ALL WEARSæ–°åŒ—æ–°åº—è£•éš†åŸ(AKW	allwears20@gmail.com
AS001	ALL WEARSå°ä¸­éº—å¯¶åº—(AKW)	life8x35@gmail.com
AS002	ALL WEARSå°ä¸­ä¸‰äº•åº—(AKW)	allwears04@gmail.com
AM001	ALL WEARSå°ä¸­æ–°æ™‚ä»£åº—(AKW)	life8x33@gmail.com
AM004	ALL WEARSå°ä¸­å¤§é ç™¾åº—(AKW)	allwears05@gmail.com
AM003	ALL WEARSé«˜é›„å¤¢æ™‚ä»£åº—(AKW)	allwears07@gmail.com
AS007	ALL WEARSå°å—ä¸‰äº•åº—(AKW)	allwears15@gmail.com
WS003	WILDMEETæ¡ƒåœ’è¯æ³°åº—(WAK)	wildmeet08@gmail.com
WM007	WILDMEETå°åŒ—äº¬ç«™(WN)	wildmeet09@gmail.com
WM009	WILDMEETæ–°å…‰å—è¥¿(WN)	wildmeet07@gmail.com
WS007	WILDMEETæ—å£ä¸‰äº•åº—(WAKN)	wildmeet13@gmail.com
WM012	WILDMEETæ–°åŒ—å®åŒ¯(WN)	wildmeet14@gmail.com
WM011	WILDMEETæ¡ƒåœ’å¤§æ±Ÿè³¼ç‰©(WAKN)	wildmeet15@gmail.com
WS001	WILDMEETå°ä¸­éº—å¯¶åº—(WAKN)	wildmeet02@gmail.com
WM006	WILDMEETå°ä¸­è€è™åŸåº—(WN)	wildmeet10@gmail.com
WS009	WILDMEET-WMè‹—æ —å°šé †(WN)	wildmeet11@gmail.com
WS002	WILDMEETé«˜é›„SKMåº—(WN)	wildmeet03@gmail.com
WM003	WILDMEETå˜‰ç¾©ç§€æ³°åº—(WN)	wildmeet04@gmail.com
WM005	WILDMEETå±æ±ç’°çƒåº—(WN)	wildmeet06@gmail.com
WM010	WILDMEETæ–°å…‰å°å—ä¸­å±±(WAK)	wildmeet12@gmail.com		
BS001	BOYLONDONæ—å£ä¸‰äº•åº—(BN)	boylondonx01@gmail.com
BS002	BOYLONDONå°ä¸­ä¸‰äº•åº—(BN)	boylondonx02@gmail.com
BM001	BOYLONDONå°ä¸­LaLaportåº—	boylondonx03@gmail.com
BS003	BOYLONDONå°å—ä¸‰äº•åº—(BN)	boylondonx04@gmail.com
MM001	Mollifixå°åŒ—å¾©èˆˆSOGO(M)	mollifix01@gmail.com
MM003	Mollifixå°åŒ—å—è¥¿æ–°å…‰(ME)	mollifix03@gmail.com
MM008	Mollifixå°åŒ—äº¬ç«™(ME)	mollifix04@gmail.com
MM007	Mollifixæ¡ƒåœ’å¤§æ±Ÿ(ME)	mollifix06@gmail.com
MM010	Mollifixå°åŒ—å—æ¸¯City(ME)	mollifix07@gmail.com
MM006	Mollifixå°ä¸­LLP(ME)	mollifix08@gmail.com
MM009	Mollifixé«˜é›„æ¼¢ç¥å·¨è›‹(ME)	mollifix09@gmail.com
MM004	Mollifixå°å—å°è¥¿é–€(ME)	mollifix10@gmail.com
NM001	NonSpaceå—æ¸¯LLP(NZ)	nonspace02@gmail.com
NM003	NonSpaceä¸­å’Œç’°çƒ(NZ)	nonspace03@gmail.com


-----2041-----
import streamlit as st
import pandas as pd
from io import BytesIO
import zipfile

FILE_URL = "https://raw.githubusercontent.com/ainstaccc/kpi-checker/main/2025.06_MST-PA.xlsx"

@st.cache_data(ttl=3600)
def load_data():
    xls = pd.ExcelFile(FILE_URL, engine="openpyxl")
    df_summary = xls.parse("é–€åº— è€ƒæ ¸ç¸½è¡¨", header=1)
    df_eff = xls.parse("äººæ•ˆåˆ†æ", header=1)
    df_mgr = xls.parse("åº—é•·å‰¯åº— è€ƒæ ¸æ˜ç´°", header=1)
    df_staff = xls.parse("åº—å“¡å„²å‚™ è€ƒæ ¸æ˜ç´°", header=1)
    df_dist = xls.parse("ç­‰ç´šåˆ†å¸ƒ", header=None, nrows=15, usecols="A:N")
    summary_month = xls.parse("é–€åº— è€ƒæ ¸ç¸½è¡¨", nrows=1).columns[0]
    return df_summary, df_eff, df_mgr, df_staff, df_dist, summary_month

def format_eff(df):
    if df.empty:
        return df
    df = df.copy()
    for col in ["å€‹ç¸¾ç›®æ¨™", "å€‹ç¸¾è²¢ç»", "å“ç‰Œ å®¢å–®åƒ¹", "å€‹äºº å®¢å–®åƒ¹"]:
        if col in df.columns:
            df[col] = pd.to_numeric(df[col], errors='coerce').round(1)
    for col in ["å€‹ç¸¾é”æˆ%", "å®¢å–® ç›¸å°ç¸¾æ•ˆ", "å“ç‰Œ çµå¸³æœƒå“¡ç‡", "å€‹äºº çµå¸³æœƒå“¡ç‡", "æœƒå“¡ ç›¸å°ç¸¾æ•ˆ"]:
        if col in df.columns:
            df[col] = df[col].apply(lambda x: f"{x}%" if pd.notnull(x) else x)
    return df

def main():
    st.markdown("<h3>ğŸ“Š ç±³æ–¯ç‰¹ é–€å¸‚ å·¥ä½œç¸¾æ•ˆæœˆè€ƒæ ¸æŸ¥è©¢ç³»çµ±</h3>", unsafe_allow_html=True)

    df_summary, df_eff, df_mgr, df_staff, df_dist, summary_month = load_data()

    with st.expander("ğŸ” æŸ¥è©¢æ¢ä»¶", expanded=True):
        st.markdown("**ğŸ”ºæŸ¥è©¢æ¢ä»¶ä»»ä¸€æ¬„å³å¯ï¼Œé¿å…å¤šé‡æ¢ä»¶é€ æˆæŸ¥è©¢éŒ¯èª¤ã€‚**")
        col1, col2 = st.columns(2)
        area = col1.selectbox("å€åŸŸ/å€ä¸»ç®¡", options=[
            "", "ææ”¿å‹³", "é„§æ€æ€", "æ—å®¥å„’", "ç¾…å©‰å¿ƒ", "ç‹å»ºæ¨¹", "æ¥ŠèŒœè¿", 
            "é™³å®¥è“‰", "å³å²±ä¾‘", "ç¿è–é–”", "é»ƒå•Ÿå‘¨", "æ —æ™‰å±", "ç‹ç‘è¾°"
        ])
        dept_code = col2.text_input("éƒ¨é–€ç·¨è™Ÿ/é–€åº—ç·¨è™Ÿ")
        emp_id = st.text_input("å“¡å·¥ç·¨è™Ÿ")
        emp_name = st.text_input("äººå“¡å§“å")
        month = st.selectbox("æŸ¥è©¢æœˆä»½", options=["2025/06"])

    st.markdown(" <br><br>", unsafe_allow_html=True)
    st.image("https://github.com/ainstaccc/kpi-checker/raw/main/2025.06%20%E8%80%83%E6%A0%B8%E7%AD%89%E7%B4%9A%E5%88%86%E5%B8%83.jpg", caption="2025/06 ğŸ“ˆæœ¬æœˆè€ƒæ ¸ç­‰ç´šåˆ†å¸ƒ", use_container_width=True)
    st.markdown("<br>", unsafe_allow_html=True)

    if st.button("ğŸ” æŸ¥è©¢", type="primary"):

        # Filter logic for summary
        mask = pd.Series(True, index=df_summary.index)
        if area:
            mask &= df_summary["å€ä¸»ç®¡"] == area
        if dept_code:
            mask &= df_summary["éƒ¨é–€ç·¨è™Ÿ"] == dept_code
        if emp_id:
            mask &= df_summary["å“¡ç·¨"].astype(str) == emp_id
        if emp_name:
            mask &= df_summary["äººå“¡å§“å"].str.contains(emp_name)

        df_result = df_summary[mask]

        # åˆ†é–‹ç‚ºå…¶ä»–è¡¨æ ¼å»ºç«‹é®ç½©
        eff_mask = pd.Series(True, index=df_eff.index)
        mgr_mask = pd.Series(True, index=df_mgr.index)
        staff_mask = pd.Series(True, index=df_staff.index)

        if area:
            eff_mask &= df_eff["å€ä¸»ç®¡"] == area
            mgr_mask &= df_mgr["å€ä¸»ç®¡"] == area
            staff_mask &= df_staff["å€ä¸»ç®¡"] == area
        if dept_code:
            eff_mask &= df_eff["éƒ¨é–€ç·¨è™Ÿ"] == dept_code
            mgr_mask &= df_mgr["éƒ¨é–€ç·¨è™Ÿ"] == dept_code
            staff_mask &= df_staff["éƒ¨é–€ç·¨è™Ÿ"] == dept_code
        if emp_id:
            eff_mask &= df_eff["å“¡ç·¨"].astype(str) == emp_id
            mgr_mask &= df_mgr["å“¡ç·¨"].astype(str) == emp_id
            staff_mask &= df_staff["å“¡ç·¨"].astype(str) == emp_id
        if emp_name:
            eff_mask &= df_eff["äººå“¡å§“å"].str.contains(emp_name)
            mgr_mask &= df_mgr["äººå“¡å§“å"].str.contains(emp_name)
            staff_mask &= df_staff["äººå“¡å§“å"].str.contains(emp_name)

        df_eff_result = df_eff[eff_mask]
        df_mgr_result = df_mgr[mgr_mask]
        df_staff_result = df_staff[staff_mask]

        st.markdown("## ğŸ§¾ é–€åº—è€ƒæ ¸ç¸½è¡¨")
        st.markdown(f"å…±æŸ¥å¾—ï¼š{len(df_result)} ç­†")
        st.dataframe(df_result.iloc[:, 2:11], use_container_width=True)

        st.markdown("## ğŸ‘¥ äººæ•ˆåˆ†æ")
        df_eff_result_fmt = format_eff(df_eff_result)
        
        # å–å¾—æ‰€æœ‰æ¬„ä½åç¨±
        columns = df_eff_result_fmt.columns
        
        # æ•´æ•¸æ¬„ï¼ˆåƒåˆ†ä½ï¼‰
        int_columns = [columns[6], columns[7], columns[9], columns[10]]
        # ç™¾åˆ†æ¯”æ¬„
        percent_columns = columns[11:15]
        
        # å»ºç«‹æ ¼å¼åŒ–å­—å…¸
        format_dict = {col: "{:,.0f}" for col in int_columns}
        format_dict.update({col: "{:.0%}" for col in percent_columns})
        format_dict[columns[3]] = "{:08.0f}"  # å“¡ç·¨é¡¯ç¤ºç‚º8ä½æ•´æ•¸
        
        # é¡¯ç¤º
        st.markdown(f"å…±æŸ¥å¾—ï¼š{len(df_eff_result_fmt)} ç­†")
        st.dataframe(df_eff_result_fmt.style.format(format_dict), use_container_width=True)




        st.markdown("## ğŸ‘” åº—é•·/å‰¯åº— è€ƒæ ¸æ˜ç´°")
        st.markdown(f"å…±æŸ¥å¾—ï¼š{len(df_mgr_result)} ç­†")

        # åªé¡¯ç¤ºç¬¬2ï½7æ¬„èˆ‡ç¬¬12ï½28æ¬„
        df_mgr_display = pd.concat([
            df_mgr_result.iloc[:, 1:7],    # ç¬¬2~7æ¬„
            df_mgr_result.iloc[:, 11:28]   # ç¬¬12~28æ¬„
        ], axis=1)

        df_mgr_head_display = pd.concat([
            df_mgr.iloc[:, 1:7], 
            df_mgr.iloc[:, 11:28]
        ], axis=1).head(0)

        st.dataframe(df_mgr_display if not df_mgr_display.empty else df_mgr_head_display, use_container_width=True)

        st.markdown("## ğŸ‘Ÿ åº—å“¡/å„²å‚™ è€ƒæ ¸æ˜ç´°")
        st.markdown(f"å…±æŸ¥å¾—ï¼š{len(df_staff_result)} ç­†")

        # åªé¡¯ç¤ºç¬¬2ï½7æ¬„èˆ‡ç¬¬12ï½28æ¬„
        df_staff_display = pd.concat([
            df_staff_result.iloc[:, 1:7],     # ç¬¬2~7æ¬„
            df_staff_result.iloc[:, 11:28]    # ç¬¬12~28æ¬„
        ], axis=1)

        df_staff_head_display = pd.concat([
            df_staff.iloc[:, 1:7], 
            df_staff.iloc[:, 11:28]
        ], axis=1).head(0)

        st.dataframe(df_staff_display if not df_staff_display.empty else df_staff_head_display, use_container_width=True)


        # åŒ¯å‡ºçµæœæŒ‰éˆ•
        export_zip = BytesIO()
        with zipfile.ZipFile(export_zip, mode="w", compression=zipfile.ZIP_DEFLATED) as zf:
            zf.writestr("é–€åº—è€ƒæ ¸ç¸½è¡¨.csv", df_result.to_csv(index=False, encoding="utf-8-sig"))
            zf.writestr("äººæ•ˆåˆ†æ.csv", df_eff_result.to_csv(index=False, encoding="utf-8-sig"))
            zf.writestr("åº—é•·å‰¯åº— è€ƒæ ¸æ˜ç´°.csv", df_mgr_result.to_csv(index=False, encoding="utf-8-sig"))
            zf.writestr("åº—å“¡å„²å‚™ è€ƒæ ¸æ˜ç´°.csv", df_staff_result.to_csv(index=False, encoding="utf-8-sig"))

        st.download_button(
            label="ğŸ“¥ åŒ¯å‡ºæŸ¥è©¢çµæœï¼ˆExcel ZIPï¼‰",
            data=export_zip.getvalue(),
            file_name="æŸ¥è©¢çµæœ.zip",
            mime="application/zip"
        )

        st.markdown("<p style='color:red;font-weight:bold;font-size:16px;'>â€»å¦‚å°åˆ†æ•¸æœ‰ç–‘å•ï¼Œè«‹æ´½å€ä¸»ç®¡/å“ç‰Œç¶“ç†èªªæ˜ã€‚</p>", unsafe_allow_html=True)

if __name__ == "__main__":
    main()
